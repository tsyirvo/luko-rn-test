c1c6211e0ce53768311608d4c7f29b59
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault2(require("@babel/runtime/helpers/defineProperty"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = TabRouter;
exports.TabActions = void 0;

var _nonSecure = require("nanoid/non-secure");

var _BaseRouter = _interopRequireDefault(require("./BaseRouter"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

var TYPE_ROUTE = 'route';
var TabActions = {
  jumpTo: function jumpTo(name, params) {
    return {
      type: 'JUMP_TO',
      payload: {
        name: name,
        params: params
      }
    };
  }
};
exports.TabActions = TabActions;

var getRouteHistory = function getRouteHistory(routes, index, backBehavior, initialRouteName) {
  var history = [{
    type: TYPE_ROUTE,
    key: routes[index].key
  }];
  var initialRouteIndex;

  switch (backBehavior) {
    case 'order':
      for (var i = index; i > 0; i--) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[i - 1].key
        });
      }

      break;

    case 'firstRoute':
      if (index !== 0) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[0].key
        });
      }

      break;

    case 'initialRoute':
      initialRouteIndex = routes.findIndex(function (route) {
        return route.name === initialRouteName;
      });
      initialRouteIndex = initialRouteIndex === -1 ? 0 : initialRouteIndex;

      if (index !== initialRouteIndex) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[initialRouteIndex].key
        });
      }

      break;

    case 'history':
      break;
  }

  return history;
};

var changeIndex = function changeIndex(state, index, backBehavior, initialRouteName) {
  var history;

  if (backBehavior === 'history') {
    var currentKey = state.routes[index].key;
    history = state.history.filter(function (it) {
      return it.type === 'route' ? it.key !== currentKey : false;
    }).concat({
      type: TYPE_ROUTE,
      key: currentKey
    });
  } else {
    history = getRouteHistory(state.routes, index, backBehavior, initialRouteName);
  }

  return _objectSpread(_objectSpread({}, state), {}, {
    index: index,
    history: history
  });
};

function TabRouter(_ref) {
  var initialRouteName = _ref.initialRouteName,
      _ref$backBehavior = _ref.backBehavior,
      backBehavior = _ref$backBehavior === void 0 ? 'history' : _ref$backBehavior;

  var router = _objectSpread(_objectSpread({}, _BaseRouter.default), {}, {
    type: 'tab',
    getInitialState: function getInitialState(_ref2) {
      var routeNames = _ref2.routeNames,
          routeParamList = _ref2.routeParamList;
      var index = initialRouteName !== undefined && routeNames.includes(initialRouteName) ? routeNames.indexOf(initialRouteName) : 0;
      var routes = routeNames.map(function (name) {
        return {
          name: name,
          key: "".concat(name, "-").concat((0, _nonSecure.nanoid)()),
          params: routeParamList[name]
        };
      });
      var history = getRouteHistory(routes, index, backBehavior, initialRouteName);
      return {
        stale: false,
        type: 'tab',
        key: "tab-".concat((0, _nonSecure.nanoid)()),
        index: index,
        routeNames: routeNames,
        history: history,
        routes: routes
      };
    },
    getRehydratedState: function getRehydratedState(partialState, _ref3) {
      var routeNames = _ref3.routeNames,
          routeParamList = _ref3.routeParamList;

      var _state$routes, _state$index, _state$history$filter, _state$history;

      var state = partialState;

      if (state.stale === false) {
        return state;
      }

      var routes = routeNames.map(function (name) {
        var route = state.routes.find(function (r) {
          return r.name === name;
        });
        return _objectSpread(_objectSpread({}, route), {}, {
          name: name,
          key: route && route.name === name && route.key ? route.key : "".concat(name, "-").concat((0, _nonSecure.nanoid)()),
          params: routeParamList[name] !== undefined ? _objectSpread(_objectSpread({}, routeParamList[name]), route ? route.params : undefined) : route ? route.params : undefined
        });
      });
      var index = Math.min(Math.max(routeNames.indexOf((_state$routes = state.routes[(_state$index = state === null || state === void 0 ? void 0 : state.index) !== null && _state$index !== void 0 ? _state$index : 0]) === null || _state$routes === void 0 ? void 0 : _state$routes.name), 0), routes.length - 1);
      var history = (_state$history$filter = (_state$history = state.history) === null || _state$history === void 0 ? void 0 : _state$history.filter(function (it) {
        return routes.find(function (r) {
          return r.key === it.key;
        });
      })) !== null && _state$history$filter !== void 0 ? _state$history$filter : [];
      return changeIndex({
        stale: false,
        type: 'tab',
        key: "tab-".concat((0, _nonSecure.nanoid)()),
        index: index,
        routeNames: routeNames,
        history: history,
        routes: routes
      }, index, backBehavior, initialRouteName);
    },
    getStateForRouteNamesChange: function getStateForRouteNamesChange(state, _ref4) {
      var routeNames = _ref4.routeNames,
          routeParamList = _ref4.routeParamList;
      var routes = routeNames.map(function (name) {
        return state.routes.find(function (r) {
          return r.name === name;
        }) || {
          name: name,
          key: "".concat(name, "-").concat((0, _nonSecure.nanoid)()),
          params: routeParamList[name]
        };
      });
      var index = Math.max(0, routeNames.indexOf(state.routes[state.index].name));
      var history = state.history.filter(function (it) {
        return it.type !== 'route' || routes.find(function (r) {
          return r.key === it.key;
        });
      });

      if (!history.length) {
        history = getRouteHistory(routes, index, backBehavior, initialRouteName);
      }

      return _objectSpread(_objectSpread({}, state), {}, {
        history: history,
        routeNames: routeNames,
        routes: routes,
        index: index
      });
    },
    getStateForRouteFocus: function getStateForRouteFocus(state, key) {
      var index = state.routes.findIndex(function (r) {
        return r.key === key;
      });

      if (index === -1 || index === state.index) {
        return state;
      }

      return changeIndex(state, index, backBehavior, initialRouteName);
    },
    getStateForAction: function getStateForAction(state, action, _ref5) {
      var routeParamList = _ref5.routeParamList;

      switch (action.type) {
        case 'JUMP_TO':
        case 'NAVIGATE':
          {
            var index = -1;

            if (action.type === 'NAVIGATE' && action.payload.key) {
              index = state.routes.findIndex(function (route) {
                return route.key === action.payload.key;
              });
            } else {
              index = state.routes.findIndex(function (route) {
                return route.name === action.payload.name;
              });
            }

            if (index === -1) {
              return null;
            }

            return changeIndex(_objectSpread(_objectSpread({}, state), {}, {
              routes: action.payload.params !== undefined ? state.routes.map(function (route, i) {
                if (i !== index) {
                  return route;
                }

                var params;

                if (action.type === 'NAVIGATE' && action.payload.merge === false) {
                  params = routeParamList[route.name] !== undefined ? _objectSpread(_objectSpread({}, routeParamList[route.name]), action.payload.params) : action.payload.params;
                } else {
                  params = action.payload.params ? _objectSpread(_objectSpread({}, route.params), action.payload.params) : route.params;
                }

                return params !== route.params ? _objectSpread(_objectSpread({}, route), {}, {
                  params: params
                }) : route;
              }) : state.routes
            }), index, backBehavior, initialRouteName);
          }

        case 'GO_BACK':
          {
            if (state.history.length === 1) {
              return null;
            }

            var previousKey = state.history[state.history.length - 2].key;

            var _index = state.routes.findIndex(function (route) {
              return route.key === previousKey;
            });

            if (_index === -1) {
              return null;
            }

            return _objectSpread(_objectSpread({}, state), {}, {
              history: state.history.slice(0, -1),
              index: _index
            });
          }

        default:
          return _BaseRouter.default.getStateForAction(state, action);
      }
    },
    shouldActionChangeFocus: function shouldActionChangeFocus(action) {
      return action.type === 'NAVIGATE';
    },
    actionCreators: TabActions
  });

  return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRhYlJvdXRlci50c3giXSwibmFtZXMiOlsiVFlQRV9ST1VURSIsIlRhYkFjdGlvbnMiLCJqdW1wVG8iLCJ0eXBlIiwicGF5bG9hZCIsIm5hbWUiLCJwYXJhbXMiLCJnZXRSb3V0ZUhpc3RvcnkiLCJoaXN0b3J5Iiwia2V5Iiwicm91dGVzIiwiaSIsImluZGV4IiwiaW5pdGlhbFJvdXRlSW5kZXgiLCJyb3V0ZSIsImNoYW5nZUluZGV4IiwiYmFja0JlaGF2aW9yIiwiY3VycmVudEtleSIsInN0YXRlIiwiaXQiLCJyb3V0ZXIiLCJCYXNlUm91dGVyIiwiZ2V0SW5pdGlhbFN0YXRlIiwicm91dGVQYXJhbUxpc3QiLCJpbml0aWFsUm91dGVOYW1lIiwicm91dGVOYW1lcyIsInN0YWxlIiwiZ2V0UmVoeWRyYXRlZFN0YXRlIiwiciIsInVuZGVmaW5lZCIsIk1hdGgiLCJnZXRTdGF0ZUZvclJvdXRlTmFtZXNDaGFuZ2UiLCJnZXRTdGF0ZUZvclJvdXRlRm9jdXMiLCJnZXRTdGF0ZUZvckFjdGlvbiIsImFjdGlvbiIsInByZXZpb3VzS2V5Iiwic2hvdWxkQWN0aW9uQ2hhbmdlRm9jdXMiLCJhY3Rpb25DcmVhdG9ycyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUEsVUFBQSxHQUFBLE9BQUEsQ0FBQSxtQkFBQSxDQUFBOztBQUNBLElBQUEsV0FBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxnQkFBQSxDQUFBOzs7Ozs7OztBQXlEQSxJQUFNQSxVQUFVLEdBQWhCLE9BQUE7QUFFTyxJQUFNQyxVQUFVLEdBQUc7QUFDeEJDLEVBQUFBLE1BRHdCLGtCQUNsQixJQURrQixFQUNsQixNQURrQixFQUM2QjtBQUNuRCxXQUFPO0FBQUVDLE1BQUFBLElBQUksRUFBTixTQUFBO0FBQW1CQyxNQUFBQSxPQUFPLEVBQUU7QUFBRUMsUUFBQUEsSUFBRixFQUFFQSxJQUFGO0FBQVFDLFFBQUFBLE1BQUFBLEVBQUFBO0FBQVI7QUFBNUIsS0FBUDtBQUNEO0FBSHVC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RUQsbURBQU8sS0FBUDtBQUVFSixjQUFBQSxPQUFPLEVBQUVVLEtBQUssQ0FBTEEsT0FBQUEsQ0FBQUEsS0FBQUEsQ0FBQUEsQ0FBQUEsRUFBdUIsQ0FGM0IsQ0FFSUEsQ0FGWDtBQUdFTixjQUFBQSxLQUFBQSxFQUFBQTtBQUhGO0FBS0Q7O0FBRUQ7QUFDRSxpQkFBT1MsV0FBQUEsQ0FBQUEsT0FBQUEsQ0FBQUEsaUJBQUFBLENBQUFBLEtBQUFBLEVBQVAsTUFBT0EsQ0FBUDtBQXJGSjtBQTVJQSxLQUFIO0FBcU9DZSxJQUFBQSx1QkFyT0QsbUNBcU93QixNQXJPeEIsRUFxT2lDO0FBQzlCLGFBQU9GLE1BQU0sQ0FBTkEsSUFBQUEsS0FBUCxVQUFBO0FBdE9BLEtBQUg7QUF5T0NHLElBQUFBLGNBQWMsRUFBRXBDO0FBek9qQixJQUhEOztBQStPQSxTQUFBLE1BQUE7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG5hbm9pZCB9IGZyb20gJ25hbm9pZC9ub24tc2VjdXJlJztcbmltcG9ydCBCYXNlUm91dGVyIGZyb20gJy4vQmFzZVJvdXRlcic7XG5pbXBvcnQgdHlwZSB7XG4gIE5hdmlnYXRpb25TdGF0ZSxcbiAgUGFydGlhbFN0YXRlLFxuICBDb21tb25OYXZpZ2F0aW9uQWN0aW9uLFxuICBSb3V0ZXIsXG4gIERlZmF1bHRSb3V0ZXJPcHRpb25zLFxuICBSb3V0ZSxcbiAgUGFyYW1MaXN0QmFzZSxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCB0eXBlIFRhYkFjdGlvblR5cGUgPSB7XG4gIHR5cGU6ICdKVU1QX1RPJztcbiAgcGF5bG9hZDogeyBuYW1lOiBzdHJpbmc7IHBhcmFtcz86IG9iamVjdCB9O1xuICBzb3VyY2U/OiBzdHJpbmc7XG4gIHRhcmdldD86IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIEJhY2tCZWhhdmlvciA9XG4gIHwgJ2luaXRpYWxSb3V0ZSdcbiAgfCAnZmlyc3RSb3V0ZSdcbiAgfCAnaGlzdG9yeSdcbiAgfCAnb3JkZXInXG4gIHwgJ25vbmUnO1xuXG5leHBvcnQgdHlwZSBUYWJSb3V0ZXJPcHRpb25zID0gRGVmYXVsdFJvdXRlck9wdGlvbnMgJiB7XG4gIGJhY2tCZWhhdmlvcj86IEJhY2tCZWhhdmlvcjtcbn07XG5cbmV4cG9ydCB0eXBlIFRhYk5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3QgZXh0ZW5kcyBQYXJhbUxpc3RCYXNlPiA9IE9taXQ8XG4gIE5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3Q+LFxuICAnaGlzdG9yeSdcbj4gJiB7XG4gIC8qKlxuICAgKiBUeXBlIG9mIHRoZSByb3V0ZXIsIGluIHRoaXMgY2FzZSwgaXQncyB0YWIuXG4gICAqL1xuICB0eXBlOiAndGFiJztcbiAgLyoqXG4gICAqIExpc3Qgb2YgcHJldmlvdXNseSB2aXNpdGVkIHJvdXRlIGtleXMuXG4gICAqL1xuICBoaXN0b3J5OiB7IHR5cGU6ICdyb3V0ZSc7IGtleTogc3RyaW5nIH1bXTtcbn07XG5cbmV4cG9ydCB0eXBlIFRhYkFjdGlvbkhlbHBlcnM8UGFyYW1MaXN0IGV4dGVuZHMgUGFyYW1MaXN0QmFzZT4gPSB7XG4gIC8qKlxuICAgKiBKdW1wIHRvIGFuIGV4aXN0aW5nIHRhYi5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgTmFtZSBvZiB0aGUgcm91dGUgZm9yIHRoZSB0YWIuXG4gICAqIEBwYXJhbSBbcGFyYW1zXSBQYXJhbXMgb2JqZWN0IGZvciB0aGUgcm91dGUuXG4gICAqL1xuICBqdW1wVG88Um91dGVOYW1lIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBQYXJhbUxpc3QsIHN0cmluZz4+KFxuICAgIC4uLmFyZ3M6IHVuZGVmaW5lZCBleHRlbmRzIFBhcmFtTGlzdFtSb3V0ZU5hbWVdXG4gICAgICA/IFtSb3V0ZU5hbWVdIHwgW1JvdXRlTmFtZSwgUGFyYW1MaXN0W1JvdXRlTmFtZV1dXG4gICAgICA6IFtSb3V0ZU5hbWUsIFBhcmFtTGlzdFtSb3V0ZU5hbWVdXVxuICApOiB2b2lkO1xufTtcblxuY29uc3QgVFlQRV9ST1VURSA9ICdyb3V0ZScgYXMgY29uc3Q7XG5cbmV4cG9ydCBjb25zdCBUYWJBY3Rpb25zID0ge1xuICBqdW1wVG8obmFtZTogc3RyaW5nLCBwYXJhbXM/OiBvYmplY3QpOiBUYWJBY3Rpb25UeXBlIHtcbiAgICByZXR1cm4geyB0eXBlOiAnSlVNUF9UTycsIHBheWxvYWQ6IHsgbmFtZSwgcGFyYW1zIH0gfTtcbiAgfSxcbn07XG5cbmNvbnN0IGdldFJvdXRlSGlzdG9yeSA9IChcbiAgcm91dGVzOiBSb3V0ZTxzdHJpbmc+W10sXG4gIGluZGV4OiBudW1iZXIsXG4gIGJhY2tCZWhhdmlvcjogQmFja0JlaGF2aW9yLFxuICBpbml0aWFsUm91dGVOYW1lOiBzdHJpbmcgfCB1bmRlZmluZWRcbikgPT4ge1xuICBjb25zdCBoaXN0b3J5ID0gW3sgdHlwZTogVFlQRV9ST1VURSwga2V5OiByb3V0ZXNbaW5kZXhdLmtleSB9XTtcbiAgbGV0IGluaXRpYWxSb3V0ZUluZGV4O1xuXG4gIHN3aXRjaCAoYmFja0JlaGF2aW9yKSB7XG4gICAgY2FzZSAnb3JkZXInOlxuICAgICAgZm9yIChsZXQgaSA9IGluZGV4OyBpID4gMDsgaS0tKSB7XG4gICAgICAgIGhpc3RvcnkudW5zaGlmdCh7IHR5cGU6IFRZUEVfUk9VVEUsIGtleTogcm91dGVzW2kgLSAxXS5rZXkgfSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdmaXJzdFJvdXRlJzpcbiAgICAgIGlmIChpbmRleCAhPT0gMCkge1xuICAgICAgICBoaXN0b3J5LnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6IFRZUEVfUk9VVEUsXG4gICAgICAgICAga2V5OiByb3V0ZXNbMF0ua2V5LFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2luaXRpYWxSb3V0ZSc6XG4gICAgICBpbml0aWFsUm91dGVJbmRleCA9IHJvdXRlcy5maW5kSW5kZXgoXG4gICAgICAgIChyb3V0ZSkgPT4gcm91dGUubmFtZSA9PT0gaW5pdGlhbFJvdXRlTmFtZVxuICAgICAgKTtcbiAgICAgIGluaXRpYWxSb3V0ZUluZGV4ID0gaW5pdGlhbFJvdXRlSW5kZXggPT09IC0xID8gMCA6IGluaXRpYWxSb3V0ZUluZGV4O1xuXG4gICAgICBpZiAoaW5kZXggIT09IGluaXRpYWxSb3V0ZUluZGV4KSB7XG4gICAgICAgIGhpc3RvcnkudW5zaGlmdCh7XG4gICAgICAgICAgdHlwZTogVFlQRV9ST1VURSxcbiAgICAgICAgICBrZXk6IHJvdXRlc1tpbml0aWFsUm91dGVJbmRleF0ua2V5LFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2hpc3RvcnknOlxuICAgICAgLy8gVGhlIGhpc3Rvcnkgd2lsbCBmaWxsIHVwIG9uIG5hdmlnYXRpb25cbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgcmV0dXJuIGhpc3Rvcnk7XG59O1xuXG5jb25zdCBjaGFuZ2VJbmRleCA9IChcbiAgc3RhdGU6IFRhYk5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3RCYXNlPixcbiAgaW5kZXg6IG51bWJlcixcbiAgYmFja0JlaGF2aW9yOiBCYWNrQmVoYXZpb3IsXG4gIGluaXRpYWxSb3V0ZU5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZFxuKSA9PiB7XG4gIGxldCBoaXN0b3J5O1xuXG4gIGlmIChiYWNrQmVoYXZpb3IgPT09ICdoaXN0b3J5Jykge1xuICAgIGNvbnN0IGN1cnJlbnRLZXkgPSBzdGF0ZS5yb3V0ZXNbaW5kZXhdLmtleTtcblxuICAgIGhpc3RvcnkgPSBzdGF0ZS5oaXN0b3J5XG4gICAgICAuZmlsdGVyKChpdCkgPT4gKGl0LnR5cGUgPT09ICdyb3V0ZScgPyBpdC5rZXkgIT09IGN1cnJlbnRLZXkgOiBmYWxzZSkpXG4gICAgICAuY29uY2F0KHsgdHlwZTogVFlQRV9ST1VURSwga2V5OiBjdXJyZW50S2V5IH0pO1xuICB9IGVsc2Uge1xuICAgIGhpc3RvcnkgPSBnZXRSb3V0ZUhpc3RvcnkoXG4gICAgICBzdGF0ZS5yb3V0ZXMsXG4gICAgICBpbmRleCxcbiAgICAgIGJhY2tCZWhhdmlvcixcbiAgICAgIGluaXRpYWxSb3V0ZU5hbWVcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICAuLi5zdGF0ZSxcbiAgICBpbmRleCxcbiAgICBoaXN0b3J5LFxuICB9O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gVGFiUm91dGVyKHtcbiAgaW5pdGlhbFJvdXRlTmFtZSxcbiAgYmFja0JlaGF2aW9yID0gJ2hpc3RvcnknLFxufTogVGFiUm91dGVyT3B0aW9ucykge1xuICBjb25zdCByb3V0ZXI6IFJvdXRlcjxcbiAgICBUYWJOYXZpZ2F0aW9uU3RhdGU8UGFyYW1MaXN0QmFzZT4sXG4gICAgVGFiQWN0aW9uVHlwZSB8IENvbW1vbk5hdmlnYXRpb25BY3Rpb25cbiAgPiA9IHtcbiAgICAuLi5CYXNlUm91dGVyLFxuXG4gICAgdHlwZTogJ3RhYicsXG5cbiAgICBnZXRJbml0aWFsU3RhdGUoeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCB9KSB7XG4gICAgICBjb25zdCBpbmRleCA9XG4gICAgICAgIGluaXRpYWxSb3V0ZU5hbWUgIT09IHVuZGVmaW5lZCAmJiByb3V0ZU5hbWVzLmluY2x1ZGVzKGluaXRpYWxSb3V0ZU5hbWUpXG4gICAgICAgICAgPyByb3V0ZU5hbWVzLmluZGV4T2YoaW5pdGlhbFJvdXRlTmFtZSlcbiAgICAgICAgICA6IDA7XG5cbiAgICAgIGNvbnN0IHJvdXRlcyA9IHJvdXRlTmFtZXMubWFwKChuYW1lKSA9PiAoe1xuICAgICAgICBuYW1lLFxuICAgICAgICBrZXk6IGAke25hbWV9LSR7bmFub2lkKCl9YCxcbiAgICAgICAgcGFyYW1zOiByb3V0ZVBhcmFtTGlzdFtuYW1lXSxcbiAgICAgIH0pKTtcblxuICAgICAgY29uc3QgaGlzdG9yeSA9IGdldFJvdXRlSGlzdG9yeShcbiAgICAgICAgcm91dGVzLFxuICAgICAgICBpbmRleCxcbiAgICAgICAgYmFja0JlaGF2aW9yLFxuICAgICAgICBpbml0aWFsUm91dGVOYW1lXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGFsZTogZmFsc2UsXG4gICAgICAgIHR5cGU6ICd0YWInLFxuICAgICAgICBrZXk6IGB0YWItJHtuYW5vaWQoKX1gLFxuICAgICAgICBpbmRleCxcbiAgICAgICAgcm91dGVOYW1lcyxcbiAgICAgICAgaGlzdG9yeSxcbiAgICAgICAgcm91dGVzLFxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgZ2V0UmVoeWRyYXRlZFN0YXRlKHBhcnRpYWxTdGF0ZSwgeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCB9KSB7XG4gICAgICBsZXQgc3RhdGUgPSBwYXJ0aWFsU3RhdGU7XG5cbiAgICAgIGlmIChzdGF0ZS5zdGFsZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByb3V0ZXMgPSByb3V0ZU5hbWVzLm1hcCgobmFtZSkgPT4ge1xuICAgICAgICBjb25zdCByb3V0ZSA9IChzdGF0ZSBhcyBQYXJ0aWFsU3RhdGU8XG4gICAgICAgICAgVGFiTmF2aWdhdGlvblN0YXRlPFBhcmFtTGlzdEJhc2U+XG4gICAgICAgID4pLnJvdXRlcy5maW5kKChyKSA9PiByLm5hbWUgPT09IG5hbWUpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4ucm91dGUsXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBrZXk6XG4gICAgICAgICAgICByb3V0ZSAmJiByb3V0ZS5uYW1lID09PSBuYW1lICYmIHJvdXRlLmtleVxuICAgICAgICAgICAgICA/IHJvdXRlLmtleVxuICAgICAgICAgICAgICA6IGAke25hbWV9LSR7bmFub2lkKCl9YCxcbiAgICAgICAgICBwYXJhbXM6XG4gICAgICAgICAgICByb3V0ZVBhcmFtTGlzdFtuYW1lXSAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgLi4ucm91dGVQYXJhbUxpc3RbbmFtZV0sXG4gICAgICAgICAgICAgICAgICAuLi4ocm91dGUgPyByb3V0ZS5wYXJhbXMgOiB1bmRlZmluZWQpLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiByb3V0ZVxuICAgICAgICAgICAgICA/IHJvdXRlLnBhcmFtc1xuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgfSBhcyBSb3V0ZTxzdHJpbmc+O1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGluZGV4ID0gTWF0aC5taW4oXG4gICAgICAgIE1hdGgubWF4KHJvdXRlTmFtZXMuaW5kZXhPZihzdGF0ZS5yb3V0ZXNbc3RhdGU/LmluZGV4ID8/IDBdPy5uYW1lKSwgMCksXG4gICAgICAgIHJvdXRlcy5sZW5ndGggLSAxXG4gICAgICApO1xuXG4gICAgICBjb25zdCBoaXN0b3J5ID1cbiAgICAgICAgc3RhdGUuaGlzdG9yeT8uZmlsdGVyKChpdCkgPT4gcm91dGVzLmZpbmQoKHIpID0+IHIua2V5ID09PSBpdC5rZXkpKSA/P1xuICAgICAgICBbXTtcblxuICAgICAgcmV0dXJuIGNoYW5nZUluZGV4KFxuICAgICAgICB7XG4gICAgICAgICAgc3RhbGU6IGZhbHNlLFxuICAgICAgICAgIHR5cGU6ICd0YWInLFxuICAgICAgICAgIGtleTogYHRhYi0ke25hbm9pZCgpfWAsXG4gICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgcm91dGVOYW1lcyxcbiAgICAgICAgICBoaXN0b3J5LFxuICAgICAgICAgIHJvdXRlcyxcbiAgICAgICAgfSxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIGJhY2tCZWhhdmlvcixcbiAgICAgICAgaW5pdGlhbFJvdXRlTmFtZVxuICAgICAgKTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JSb3V0ZU5hbWVzQ2hhbmdlKHN0YXRlLCB7IHJvdXRlTmFtZXMsIHJvdXRlUGFyYW1MaXN0IH0pIHtcbiAgICAgIGNvbnN0IHJvdXRlcyA9IHJvdXRlTmFtZXMubWFwKFxuICAgICAgICAobmFtZSkgPT5cbiAgICAgICAgICBzdGF0ZS5yb3V0ZXMuZmluZCgocikgPT4gci5uYW1lID09PSBuYW1lKSB8fCB7XG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAga2V5OiBgJHtuYW1lfS0ke25hbm9pZCgpfWAsXG4gICAgICAgICAgICBwYXJhbXM6IHJvdXRlUGFyYW1MaXN0W25hbWVdLFxuICAgICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGluZGV4ID0gTWF0aC5tYXgoXG4gICAgICAgIDAsXG4gICAgICAgIHJvdXRlTmFtZXMuaW5kZXhPZihzdGF0ZS5yb3V0ZXNbc3RhdGUuaW5kZXhdLm5hbWUpXG4gICAgICApO1xuXG4gICAgICBsZXQgaGlzdG9yeSA9IHN0YXRlLmhpc3RvcnkuZmlsdGVyKFxuICAgICAgICAvLyBUeXBlIHdpbGwgYWx3YXlzIGJlICdyb3V0ZScgZm9yIHRhYnMsIGJ1dCBjb3VsZCBiZSBkaWZmZXJlbnQgaW4gYSByb3V0ZXIgZXh0ZW5kaW5nIHRoaXMgKGUuZy4gZHJhd2VyKVxuICAgICAgICAoaXQpID0+IGl0LnR5cGUgIT09ICdyb3V0ZScgfHwgcm91dGVzLmZpbmQoKHIpID0+IHIua2V5ID09PSBpdC5rZXkpXG4gICAgICApO1xuXG4gICAgICBpZiAoIWhpc3RvcnkubGVuZ3RoKSB7XG4gICAgICAgIGhpc3RvcnkgPSBnZXRSb3V0ZUhpc3RvcnkoXG4gICAgICAgICAgcm91dGVzLFxuICAgICAgICAgIGluZGV4LFxuICAgICAgICAgIGJhY2tCZWhhdmlvcixcbiAgICAgICAgICBpbml0aWFsUm91dGVOYW1lXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBoaXN0b3J5LFxuICAgICAgICByb3V0ZU5hbWVzLFxuICAgICAgICByb3V0ZXMsXG4gICAgICAgIGluZGV4LFxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JSb3V0ZUZvY3VzKHN0YXRlLCBrZXkpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gc3RhdGUucm91dGVzLmZpbmRJbmRleCgocikgPT4gci5rZXkgPT09IGtleSk7XG5cbiAgICAgIGlmIChpbmRleCA9PT0gLTEgfHwgaW5kZXggPT09IHN0YXRlLmluZGV4KSB7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNoYW5nZUluZGV4KHN0YXRlLCBpbmRleCwgYmFja0JlaGF2aW9yLCBpbml0aWFsUm91dGVOYW1lKTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JBY3Rpb24oc3RhdGUsIGFjdGlvbiwgeyByb3V0ZVBhcmFtTGlzdCB9KSB7XG4gICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgJ0pVTVBfVE8nOlxuICAgICAgICBjYXNlICdOQVZJR0FURSc6IHtcbiAgICAgICAgICBsZXQgaW5kZXggPSAtMTtcblxuICAgICAgICAgIGlmIChhY3Rpb24udHlwZSA9PT0gJ05BVklHQVRFJyAmJiBhY3Rpb24ucGF5bG9hZC5rZXkpIHtcbiAgICAgICAgICAgIGluZGV4ID0gc3RhdGUucm91dGVzLmZpbmRJbmRleChcbiAgICAgICAgICAgICAgKHJvdXRlKSA9PiByb3V0ZS5rZXkgPT09IGFjdGlvbi5wYXlsb2FkLmtleVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW5kZXggPSBzdGF0ZS5yb3V0ZXMuZmluZEluZGV4KFxuICAgICAgICAgICAgICAocm91dGUpID0+IHJvdXRlLm5hbWUgPT09IGFjdGlvbi5wYXlsb2FkLm5hbWVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGNoYW5nZUluZGV4KFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgcm91dGVzOlxuICAgICAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkLnBhcmFtcyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICA/IHN0YXRlLnJvdXRlcy5tYXAoKHJvdXRlLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKGkgIT09IGluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcm91dGU7XG4gICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgbGV0IHBhcmFtcztcblxuICAgICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi50eXBlID09PSAnTkFWSUdBVEUnICYmXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24ucGF5bG9hZC5tZXJnZSA9PT0gZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlUGFyYW1MaXN0W3JvdXRlLm5hbWVdICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucm91dGVQYXJhbUxpc3Rbcm91dGUubmFtZV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLmFjdGlvbi5wYXlsb2FkLnBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGFjdGlvbi5wYXlsb2FkLnBhcmFtcztcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gYWN0aW9uLnBheWxvYWQucGFyYW1zXG4gICAgICAgICAgICAgICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucm91dGUucGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uYWN0aW9uLnBheWxvYWQucGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgOiByb3V0ZS5wYXJhbXM7XG4gICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmFtcyAhPT0gcm91dGUucGFyYW1zXG4gICAgICAgICAgICAgICAgICAgICAgICA/IHsgLi4ucm91dGUsIHBhcmFtcyB9XG4gICAgICAgICAgICAgICAgICAgICAgICA6IHJvdXRlO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgOiBzdGF0ZS5yb3V0ZXMsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICBiYWNrQmVoYXZpb3IsXG4gICAgICAgICAgICBpbml0aWFsUm91dGVOYW1lXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNhc2UgJ0dPX0JBQ0snOiB7XG4gICAgICAgICAgaWYgKHN0YXRlLmhpc3RvcnkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBwcmV2aW91c0tleSA9IHN0YXRlLmhpc3Rvcnlbc3RhdGUuaGlzdG9yeS5sZW5ndGggLSAyXS5rZXk7XG4gICAgICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5yb3V0ZXMuZmluZEluZGV4KFxuICAgICAgICAgICAgKHJvdXRlKSA9PiByb3V0ZS5rZXkgPT09IHByZXZpb3VzS2V5XG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgIGhpc3Rvcnk6IHN0YXRlLmhpc3Rvcnkuc2xpY2UoMCwgLTEpLFxuICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmV0dXJuIEJhc2VSb3V0ZXIuZ2V0U3RhdGVGb3JBY3Rpb24oc3RhdGUsIGFjdGlvbik7XG4gICAgICB9XG4gICAgfSxcblxuICAgIHNob3VsZEFjdGlvbkNoYW5nZUZvY3VzKGFjdGlvbikge1xuICAgICAgcmV0dXJuIGFjdGlvbi50eXBlID09PSAnTkFWSUdBVEUnO1xuICAgIH0sXG5cbiAgICBhY3Rpb25DcmVhdG9yczogVGFiQWN0aW9ucyxcbiAgfTtcblxuICByZXR1cm4gcm91dGVyO1xufVxuIl19